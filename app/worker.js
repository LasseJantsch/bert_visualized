import { pipeline, AutoTokenizer, BertForMaskedLM, BaseModelOutput, env, BertForSequenceClassification, AutoModel, max } from "@xenova/transformers";

// Skip local model check
env.allowLocalModels = false;


function getRandomIntInclusive(min, max) {
    const minCeiled = Math.ceil(min);
    const maxFloored = Math.floor(max);
    return Math.floor(Math.random() * (maxFloored - minCeiled + 1) + minCeiled)
}

function shuffle(array) {
    let currentIndex = array.length;
  
    // While there remain elements to shuffle...
    while (currentIndex != 0) {
  
      // Pick a remaining element...
      let randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex--;
  
      // And swap it with the current element.
      [array[currentIndex], array[randomIndex]] = [
        array[randomIndex], array[currentIndex]];
    }
  }

const maskText = (input, mask, token, rand, same) => {
    let newToken = []
    let len = input.length -2
    let mask_nr = Math.round(len * mask / 100)
    if (mask_nr < 1) {
      return [input, Array(input.length).fill(0)]
    } else {
        let token_arr = Array(Math.round(mask_nr * token / 100)).fill(1)
        let rand_arr = Array(Math.round(mask_nr * rand / 100)).fill(2)
        let same_arr = Array(Math.round(mask_nr * same / 100)).fill(3)
        let tokenType = Array(len-(token_arr.length + rand_arr.length + same_arr.length)).fill(0).concat(token_arr, rand_arr, same_arr)
        shuffle(tokenType)
        tokenType.unshift(0)
        tokenType.push(0)

        tokenType.forEach((t, i) => {
            if (t === 0) {
                newToken.push(input[i])
            } else if(t === 1) {
                    newToken.push(103)
                } else if (t === 2) {
                    const rand_token = getRandomIntInclusive(999, 30521) 
                    newToken.push(rand_token)
                } else {
                    newToken.push(input[i])
                }
        })
        return [newToken, tokenType]
    }  
}

// Listen for messages from the main thread
self.addEventListener('message', async (event) => {
    console.log(event.data.mode)
    if (event.data.mode === 'mlm') {
    const text = event.data.content
    const options = event.data.options
    const type = event.data.type
    let tokenizer = await AutoTokenizer.from_pretrained("Xenova/distiluse-base-multilingual-cased-v2")
    if (type==='masking') {
        if (text === '' || parseInt(options.token) + parseInt(options.rand) + parseInt(options.same) > 100) {
            console.log('invalid request')
            return
        }
        // tokenization
        let tokens = await tokenizer._encode_text(text)
        tokens.unshift('[CLS]')
        tokens.push('[SEP]')
        let encodings = await tokenizer.encode(text)

        //masking 
        let [masked_encodings, masked_encoding_types] = maskText(encodings, options.masking, options.token, options.rand, options.same)
        let masked_text = await tokenizer.decode(masked_encodings)
        let masked_tokens = await tokenizer._encode_text(masked_text)

        self.postMessage({
            status: 'complete',
            type: type,
            tokens: tokens,
            encodings: encodings,
            masked_encodings: masked_encodings,
            masked_encoding_types: masked_encoding_types,
            masked_tokens: masked_tokens,
        });
    } else if (type === 'resolving') {

        let model = await BertForMaskedLM.from_pretrained('Xenova/bert-base-uncased');
        let masked_text = await tokenizer.decode(text)
        
        // model
        let inputs = await tokenizer(masked_text, {add_special_tokens: false})
        let {logits} = await model(inputs)
        let word_probs = []
        const chunkSize = 30522;
        for (let i = 0; i < logits['data'].length; i += chunkSize) {
            const chunk = logits['data'].slice(i, i + chunkSize);
            word_probs.push(chunk)
        }   
        let first_probs = []
        let last_probs = []
        let max_enc = []
        word_probs.forEach(p => {
            first_probs.push(p[0].toFixed(2))
            last_probs.push(p[p.length-1].toFixed(2))
            max_enc.push(p.indexOf(Math.max(...p)))
        })
        let max_text = await tokenizer.decode(max_enc)
        let max_token = await tokenizer._encode_text(max_text)

        // loss
    
        // Send the output back to the main thread
        self.postMessage({
            status: 'complete',
            type: type,
            first_probs: first_probs,
            last_probs: last_probs,
            max_enc: max_enc,
            max_token: max_token
        });
    }
} else {
    const text = event.data.content
    const type = event.data.type
    let tokenizer = await AutoTokenizer.from_pretrained('Xenova/bert-base-uncased')
    let cls_model = await BertForSequenceClassification.from_pretrained('Xenova/bert-base-uncased');


    let tokens = await tokenizer._encode_text(text)
    console.log(tokens)
    tokens.unshift('[CLS]')
    tokens.push('[SEP]')
    let encodings = await tokenizer.encode(text)
    let pipe = await pipeline("feature-extraction",
                             'Xenova/bert-base-uncased');
    let out = await await pipe(text, { pooling: 'cls', normalize: false });
    let first_probs = [out.data[0].toFixed(2)]
    let last_probs = [out.data[out.data.length - 1].toFixed(0)]

    const cls_weigths = [[-0.015449526719748974, -0.006175810471177101, -0.013682612217962742, 0.023176776245236397, 0.01181089784950018, 0.0007339445874094963, 0.009086424484848976, 0.005193447694182396, -0.004681548103690147, -0.008359168656170368, -0.013429668731987476, 0.009763788431882858, 0.012374449521303177, 0.005437972489744425, 0.004552018828690052, -0.005810683127492666, -0.006383102852851152, -0.008999945595860481, 0.004803878720849752, 0.0003800328995566815, 0.012668276205658913, 0.022524090483784676, -0.005017056129872799, 0.012971448712050915, 0.004679433070123196, -0.0028526263777166605, -0.011170689016580582, 0.006949972826987505, 0.011660552583634853, 0.011841470375657082, -0.011160553433001041, -0.0015006422763690352, -0.016961505636572838, 0.0006849659257568419, -0.010339038446545601, -0.009327570907771587, 0.00761035131290555, -0.005616316106170416, -0.008931457996368408, 0.003244024235755205, -0.0059223296120762825, 0.0053963689133524895, -0.014793778769671917, 0.010569999925792217, 0.005959941539913416, -0.012937773019075394, -0.020548954606056213, 0.002166423946619034, -0.006486454978585243, 0.012645237147808075, 0.012567279860377312, 0.014743797481060028, 0.007859304547309875, 0.007412516046315432, 0.0017701637698337436, -0.007671806495636702, -0.01222771406173706, -0.003603922203183174, 0.0002239765744889155, -0.015435942448675632, -0.01136903464794159, 0.005128348711878061, -0.01138982456177473, -0.018450893461704254, 0.003181400941684842, 0.005762897897511721, -0.005711055360734463, 0.00243158801458776, 0.010587994940578938, 3.952640690840781e-05, 0.012241702526807785, -0.008952347561717033, -0.011686735786497593, -0.0066264900378882885, 0.008014426566660404, 0.00524597754701972, -0.04190918803215027, 0.03062480129301548, -0.008223922923207283, -0.009779572486877441, 0.00855240598320961, 0.0031411191448569298, 0.03829136863350868, -0.008125237189233303, 0.005900202319025993, -0.03358980640769005, 0.009126436896622181, 0.001362218172289431, -0.015285497531294823, 0.007691247388720512, 0.010450543835759163, 0.002040514722466469, 0.008256989531219006, 0.04206045717000961, -0.0022107427939772606, -0.017210684716701508, -0.0015853450167924166, -0.01591978594660759, -0.0034228148870170116, -0.011458384804427624, -0.0014342546928673983, 0.003689585952088237, 0.0006034400430507958, -0.010429603047668934, 0.006075950805097818, -0.021542789414525032, 0.004596457350999117, 0.005502117797732353, 0.006707771215587854, 0.0036878392565995455, 0.02937529794871807, -0.005731599871069193, 0.002704110462218523, -0.018164603039622307, 0.009102127514779568, 0.0037127784453332424, -0.017339574173092842, -0.040926314890384674, -0.014629817567765713, 0.007484872825443745, -0.010659551247954369, -0.007108641788363457, 0.01218025479465723, -0.0007024254882708192, 0.009215913712978363, -0.006321207154542208, -0.004808283876627684, -0.04204387217760086, -0.009419027715921402, -0.012557164765894413, -0.005182952620089054, -0.002430655062198639, -0.009704558178782463, -0.01452062651515007, 0.008800785057246685, 0.012872683815658092, 0.011744064278900623, -0.010515784844756126, -0.005590054206550121, 0.016028251498937607, -0.004070800729095936, -0.011525808833539486, 0.006795859895646572, -0.014339230954647064, 0.002074616029858589, 0.012445216998457909, -0.0035177553072571754, 0.009182983078062534, -0.011864012107253075, 0.003667370183393359, -0.011551270261406898, -0.01388076227158308, -0.008405294269323349, -0.007603869773447514, -0.008390534669160843, 0.01611899770796299, -0.006727914325892925, -0.007696382235735655, -0.0019967048428952694, -0.006890758406370878, -0.005856588017195463, 0.011071008630096912, 0.003254249691963196, 0.005220005754381418, -0.006103638093918562, 0.002697059651836753, -0.00984460860490799, 0.0022518017794936895, -0.011898570694029331, -0.007106555160135031, -0.00043702463153749704, -0.010677014477550983, -0.0071446397341787815, -0.016607841476798058, -0.007945922203361988, 0.0021928627975285053, 0.017773909494280815, 0.01086148526519537, 0.007085797842592001, 0.004986079875379801, -0.01094797533005476, 0.007887594401836395, -0.010348238050937653, 0.013899567537009716, 0.0034786234609782696, 0.0021391462069004774, -0.001420530374161899, 0.0054749660193920135, -0.014932997524738312, 0.006008733529597521, 0.005143536254763603, 0.0003097507287748158, -0.009482970461249352, -0.002454641042277217, -0.01091709267348051, -0.00790267065167427, -0.020563600584864616, 0.00791054405272007, 0.004217800684273243, -0.011713569052517414, -0.014136464335024357, 0.008840899914503098, 0.019438372924923897, -0.005238187965005636, 0.0035470612347126007, 0.014536897651851177, -0.009547729045152664, -0.009633692912757397, 0.0062426733784377575, 0.003016232280060649, 0.00011433602776378393, 0.019652405753731728, -0.008217147551476955, -0.002923855558037758, -0.016623536124825478, -0.017324412241578102, 0.004882439970970154, -0.015843110159039497, -0.0029922612011432648, -0.008978421799838543, 0.020800119265913963, -0.006777662318199873, 0.00545477494597435, 0.009355585090816021, -0.0001057105473591946, -0.0030326521955430508, 0.005199254024773836, -0.015239696018397808, -0.001337893307209015, -0.004183381795883179, 0.0013029539259150624, 0.010892624966800213, -0.014815489761531353, 0.003591149812564254, 0.01828530803322792, -0.013474876992404461, -0.014194867573678493, -0.0006600061315111816, -0.009485040791332722, 0.016548072919249535, -0.009323940612375736, 0.008529702201485634, 0.00063718156889081, 0.0136808967217803, -0.002356513636186719, -0.004400941543281078, -0.008041447028517723, 0.0037177519407123327, 0.004728636704385281, -0.0033232392743229866, 0.0036963133607059717, 0.041737981140613556, 0.0005505920853465796, 0.003335764864459634, -0.007008340209722519, 0.012425670400261879, 0.0067903450690209866, -0.006911320146173239, 0.00039032651693560183, -0.003829219611361623, -0.00923896860331297, 0.022303348407149315, -0.00024358651717193425, 0.000826402276288718, -0.008273523300886154, -0.012930543161928654, -0.013414183631539345, 0.0018105671042576432, 0.00043444213224574924, 0.017560577020049095, -0.004498759284615517, -0.004755812231451273, -0.0031203054822981358, -0.0011057050433009863, 0.010044985450804234, -0.004813471343368292, -0.004778912756592035, -0.01341893058270216, -0.018767481669783592, 0.002881122985854745, 0.01548062264919281, 0.013960173353552818, -0.0031363689340651035, 0.012190701439976692, 0.027316274121403694, 0.014459948986768723, 0.0062807537615299225, 0.005071190185844898, -0.016268951818346977, 0.00053884630324319, 0.015687882900238037, -0.005963022354990244, -0.03244447335600853, -0.01528339646756649, -0.006301834248006344, 0.0006865864270366728, -0.036611586809158325, -0.008742817677557468, -0.0033052614890038967, -0.012137485668063164, 0.000589005125220865, 0.007229944691061974, 0.01871863566339016, -0.03654235601425171, 0.009803498163819313, 0.003267338266596198, -0.046632591634988785, 0.004697978030890226, -0.005727875977754593, 0.019319642335176468, 0.01246410422027111, 0.009484444744884968, -0.0024034560192376375, 0.0013266094028949738, -0.012347061187028885, -0.019877690821886063, -0.0027452202048152685, -0.010879782028496265, 0.021172218024730682, 0.002938651479780674, -0.009467273019254208, -0.0007764428155496716, 0.0004124653642065823, -0.011467703618109226, 0.0077133821323513985, -0.015879880636930466, 0.001075002015568316, 0.007922654040157795, 0.010281071066856384, -0.004033264704048634, 0.011363804340362549, -0.01153341494500637, -0.000357048527803272, 0.005889816675335169, 0.004036932718008757, 0.03551923483610153, -0.018799729645252228, -0.003798048011958599, 0.001980893313884735, 0.0032313503324985504, -0.005551191512495279, -0.015980524942278862, 0.010849378071725368, -0.007815004326403141, 0.006221395451575518, 0.03741861507296562, 0.010537009686231613, -0.006453268695622683, 0.0012560234172269702, 0.00883179996162653, -0.011019444093108177, 0.03966518118977547, 0.010385047644376755, -0.010100003331899643, -0.04130558297038078, 0.0016222394770011306, -0.012348896823823452, -0.00894206203520298, 0.002485965844243765, -0.0052175638265907764, 0.00311001087538898, -0.001919772825203836, 0.01023393776267767, -0.009456905536353588, 0.013872486539185047, -0.013556906953454018, -0.0077260029502213, 0.011863259598612785, 0.00957096554338932, -0.0033207256346940994, -0.00044976535718888044, -0.0008629030780866742, 0.000546189141459763, 0.0029695217963308096, -0.0041698282584548, 0.013168285600841045, 0.01260931696742773, -0.0053542121313512325, 0.009312261827290058, -0.009175409562885761, -0.039653223007917404, -0.006351893302053213, -0.00800845306366682, -0.003954093903303146, 0.015565349720418453, 0.012977591715753078, -0.020387275144457817, -0.000986355822533369, -0.00689263641834259, 0.0013880489859730005, -0.017753062769770622, 0.0012917472049593925, 0.03472360968589783, -0.012526494450867176, 0.014430584385991096, -0.0015951640671119094, -0.0015414461959153414, 0.005452080629765987, 0.008622691966593266, 0.015079894103109837, -0.0043988777324557304, -0.015163281932473183, 0.011258612386882305, -0.004077770281583071, -0.011151055805385113, 0.01129254698753357, 0.0011664892081171274, 0.0029537882655858994, 0.013518424704670906, 0.002197688678279519, 0.004876913037151098, 0.006370494142174721, 0.015296067111194134, -0.0030402687843889, 0.0014278534799814224, 0.005476089194417, 0.011626019142568111, -0.0056024170480668545, 0.0429614894092083, 0.00406809663400054, -0.008474968373775482, -0.0021790892351418734, -0.005874878726899624, -0.007609232794493437, -0.014672528021037579, -0.0019247571472078562, -0.011637099087238312, 0.009912990964949131, 0.022151950746774673, 0.009196351282298565, 0.009117458947002888, 0.013536354526877403, 0.03959091380238533, -0.00804868433624506, -0.0025306951720267534, -0.0008649256196804345, 0.011218258179724216, -0.026973150670528412, -0.004115714225918055, -0.006274403538554907, 0.000863738649059087, -0.009060180746018887, -0.005834681913256645, 0.007464146241545677, -0.01644669473171234, 0.006748856510967016, 0.010825260542333126, -0.012498190626502037, -0.018354836851358414, -0.0056753745302557945, 0.004267475102096796, 0.010351663455367088, -0.014572273939847946, -0.009484144859015942, -0.0002319408959010616, 0.012552534230053425, -0.010437291115522385, -0.009907620958983898, -0.0018965257331728935, -0.006773937959223986, 0.013397013768553734, -0.0017778213368728757, 0.03385082259774208, 0.004911603406071663, 0.0026500190142542124, -0.0030073237139731646, 0.0004174570494797081, 0.010445507243275642, -0.004776859190315008, 0.005196272395551205, -0.008154347538948059, -0.009740704670548439, -0.014135656878352165, 0.03212448209524155, 0.0017619348363950849, 0.008561004884541035, 0.004236817359924316, 0.0008795081521384418, 0.006082427687942982, 0.013332977890968323, 0.018999332562088966, 0.005522580351680517, 0.0015190073754638433, -0.00708263972774148, -0.007642076816409826, -0.014772561378777027, 0.008915672078728676, 0.014364717528223991, 0.006421397905796766, 0.002763634081929922, 0.006202250719070435, -0.004799369722604752, 0.006063598673790693, 0.005572267808020115, 0.01274557039141655, 0.002060075057670474, -0.006908995099365711, -0.011405120603740215, 0.0007545980042777956, 0.0016828938387334347, -0.010001440532505512, 0.03880972042679787, -0.000492506253067404, 0.008643630892038345, -0.016987565904855728, -0.01257367618381977, -0.010050707496702671, 0.031133512035012245, 0.001472344039939344, -0.010618706233799458, 0.004554669372737408, 0.010274781845510006, -0.008463487960398197, 0.004824299365282059, 0.0033891082275658846, -0.015195546671748161, 0.010869826190173626, 0.00847530271857977, 0.006526809185743332, -0.001205767155624926, -0.014622693881392479, -0.008624810725450516, 0.007633484434336424, -0.014661915600299835, 0.013568080961704254, -0.0018747723661363125, -0.00295590260066092, -0.0032741334289312363, -0.0061934166587889194, 0.009843799285590649, -0.007707053329795599, -0.022135786712169647, -0.012192404828965664, 0.007289217785000801, 0.010922945104539394, 0.008953092619776726, -0.0430547371506691, -0.011118561029434204, 0.01737714745104313, 0.006187974009662867, -0.006022281479090452, -0.007397250737994909, -0.002229372737929225, -0.014594071544706821, 0.012480221688747406, 0.033801574259996414, 0.012253154069185257, 0.007048849482089281, 0.009775221347808838, -0.006359536666423082, 0.006312740501016378, 0.0014803264057263732, 0.008488346822559834, -0.007999991998076439, -0.0014597517438232899, -0.00043214744073338807, -0.0032725404016673565, -0.004768592771142721, -0.003936931025236845, 0.003910302184522152, 0.00045664008939638734, -0.038653597235679626, -0.003824753686785698, -0.0078788623213768, 0.007343838922679424, 0.005138535518199205, -0.012135336175560951, -0.008110763505101204, -4.936647383146919e-05, -0.007136017084121704, -0.01451142504811287, 0.009160196408629417, -0.010141103528439999, -0.025455312803387642, 0.008463678881525993, -0.03242192789912224, 0.016480283811688423, 0.007242701947689056, -0.0035525790881365538, 0.008159635588526726, -0.005501466803252697, 0.003218875965103507, 0.001146565075032413, -0.007858116179704666, -0.007146038115024567, 0.008314834907650948, -0.00859412457793951, -0.0009187677642330527, -0.010298076085746288, 0.005546147469431162, -0.010043184272944927, 0.004232507199048996, -0.0026670731604099274, 0.01634368859231472, -0.011333459056913853, 0.04325054585933685, 0.0015605157241225243, -0.014589263126254082, -0.008138627745211124, -0.00041962217073887587, -0.008610914461314678, 0.02932901307940483, -0.004378406330943108, -0.01200848538428545, 0.01177949458360672, -0.017904847860336304, -0.009039157070219517, -0.00030916344258002937, -0.0021610490512102842, -0.011762200854718685, -0.010067892260849476, 0.012711304239928722, 0.015387244522571564, -0.031666435301303864, 0.00391216017305851, -0.008562548086047173, -0.0023679547011852264, 0.006101950071752071, 0.010985544882714748, 0.00880528800189495, 0.010206148959696293, 0.0069014462642371655, -0.008642359636723995, -0.012263748794794083, 0.00972484890371561, 0.0012734191259369254, -0.003064533695578575, 0.014073277823626995, 0.02639814279973507, 0.009092483669519424, -0.018501266837120056, -0.00763291772454977, -0.008754472248256207, -0.004569991026073694, -0.0220713522285223, -6.452222442021593e-05, 0.017586026340723038, 0.013941643759608269, -0.0004570952442009002, 0.01589140295982361, -0.01747979409992695, -0.0008958235266618431, 0.0006885452312417328, 0.003026234684512019, -0.0006913096294738352, -0.005356675013899803, -0.009521708823740482, -0.0037691546604037285, 0.00976746715605259, -0.011874785646796227, -0.0027090730145573616, 0.010046891868114471, 0.0028233916964381933, 0.0029139313846826553, 0.012768646702170372, -0.031460173428058624, 0.011047129519283772, 0.0032892050221562386, 0.010797892697155476, 0.011107026599347591, 0.00804742332547903, 0.008235395886003971, 0.01604580320417881, -0.011352656409144402, -0.0015736480709165335, 0.005202878266572952, -0.0009218229097314179, 0.007497958838939667, 0.020706400275230408, 0.0014842594973742962, -0.0004660610284190625, 0.001228316337801516, -0.007270395755767822, 0.00222714408300817, -0.003298986703157425, -0.01705765910446644, 0.017846906557679176, -0.006900961045175791, -0.008150424808263779, 0.007633690256625414, -0.005229212809354067, -0.013865086250007153, 0.003338258946314454, -0.02087382785975933, 0.0010495507158339024, 0.005289223976433277, -0.002944736275821924, -0.010234478861093521, 0.005349986720830202, 0.0051359450444579124, 0.010693446733057499, 0.011804408393800259, -0.006015211343765259, 0.001787447603419423, -0.009666929952800274, 0.0012752232141792774, 0.014447486959397793, -0.020888634026050568, 0.004104346036911011, 0.011493237689137459, -0.01130987424403429, 0.002961117308586836, -0.013216852210462093, -0.006106231827288866, 0.007131138816475868, -0.006853546481579542, 0.011154686100780964, -0.006762394215911627, -0.001873828237876296, -0.013594198040664196, -0.01191737875342369, -0.011362957768142223, -0.0064923083409667015, 0.03502025455236435, 0.009188622236251831, 0.006662566680461168, 0.0048994868993759155, -0.012637271545827389, -0.007273099385201931, 0.0029162021819502115, -0.00453823059797287, -0.013865163549780846, 0.012132273055613041, -0.009552628733217716, 0.0006324595306068659, 0.004755375441163778, -0.005111517384648323, 0.009797142818570137, -0.008469555526971817, 0.008291349746286869, -0.007500643376260996, -0.014859816990792751, 0.010785777121782303, -0.013099860399961472, -0.008275717496871948, -0.007543656043708324, 0.0026858504861593246, -0.003302645403891802, 0.02474355883896351, -0.0021596746519207954, -0.012985879555344582, -0.002925609704107046, -0.0008801474468782544, 0.00649667764082551, -0.005946139805018902, -0.043643344193696976, 0.003544073086231947, -0.016034895554184914, 0.014293739572167397, -0.0033214425202459097, 0.013964253477752209, 0.001408795709721744, -0.016164712607860565, 0.0017975883092731237, 0.01090614777058363, 0.006743537727743387, -0.013461600989103317, -0.009818704798817635, 0.04467969760298729, -0.0028980476781725883, 0.0006144150393083692, 0.0062892320565879345, -0.010911857709288597, -0.0009119848255068064, 0.045142967253923416, -0.012756030075252056, -0.00989585928618908, 0.0005907316808588803], [0.00579219963401556, 0.011952249333262444, 0.012801102362573147, -0.009921391494572163, -0.0050324988551437855, 0.012391454540193081, -0.0061713214963674545, -0.009247741661965847, 0.007270519621670246, 0.004466309677809477, 0.007426752708852291, -0.00928161758929491, -0.007553557865321636, -0.002207633340731263, -0.012335612438619137, 0.006963757798075676, 0.010289447382092476, 0.011967902071774006, -0.010842160321772099, 0.011075790971517563, -0.005730186123400927, -0.02545378915965557, 0.01709846593439579, -0.004671111237257719, -0.00987974088639021, -0.016515575349330902, 0.004379358142614365, -0.00991093646734953, -0.012736527249217033, -0.005292061250656843, 0.0037557361647486687, -0.019380979239940643, 0.007259327452629805, 0.009043377824127674, 0.015354459173977375, -0.0061433566734194756, -0.01353957038372755, 0.010743287391960621, 0.005890815984457731, 0.016437482088804245, 0.004531225189566612, -0.012177114374935627, 0.010413054376840591, -0.008637329563498497, -0.009851801209151745, 0.008455798961222172, 0.02284817397594452, -0.014066895470023155, 0.012881055474281311, -0.0035497937351465225, -0.0019978678319603205, -0.015677660703659058, -0.008010180667042732, -0.014802887104451656, -0.011620023287832737, 0.007094209548085928, -0.030536659061908722, -0.016202013939619064, 0.014122771099209785, 0.0060450052842497826, 0.010667332448065281, -0.010853505693376064, 0.016151955351233482, 0.0033101956360042095, -0.018911654129624367, -0.008981107734143734, 0.014791433699429035, 0.026122380048036575, 0.02122996188700199, -0.01535063050687313, -0.014684747904539108, -0.019784092903137207, -0.0026970624458044767, 0.00839053001254797, -0.006044070236384869, -0.004995877388864756, -0.041791681200265884, -0.038543928414583206, 0.0038205760065466166, 0.006542833987623453, -0.013430389575660229, -0.010403345339000225, 0.0407470278441906, 0.010473706759512424, -0.0023342303466051817, 0.024937083944678307, -0.0034832265228033066, 0.014293638989329338, 0.002547195181250572, -0.00873449444770813, -0.004584679380059242, 0.016710903495550156, -0.006019371096044779, 0.04255090653896332, 0.0019591113086789846, 0.002239914145320654, 0.016733497381210327, 0.011729966849088669, 0.01355803944170475, 0.005748561583459377, -0.01307846698909998, 0.020084353163838387, 0.02358936332166195, -0.00048411893658339977, -0.01115500833839178, 0.0038764376658946276, 0.01116148941218853, -0.0029701250605285168, -0.005012888461351395, -0.017812024801969528, 0.0278034545481205, 0.010723290033638477, -0.012887469492852688, 0.0069382283836603165, -0.014942385256290436, 0.020693788304924965, 0.0013226609444245696, -0.04027266800403595, 0.01164256688207388, -0.009687814861536026, 0.006274272687733173, 0.006898848805576563, -0.011099944822490215, 0.010452602989971638, -0.007695252541452646, 0.008450460620224476, 0.020042506977915764, 0.03946941718459129, 0.0008355506579391658, -0.0006288813310675323, 0.01108629908412695, 0.015966126695275307, 0.01058904267847538, 0.002097394084557891, -0.013574705459177494, -0.010333954356610775, -0.0015791613841429353, 0.002843651454895735, 0.013135021552443504, 0.0021831970661878586, 0.0003784412983804941, 0.0014205829938873649, -0.007932464592158794, 0.0036771115846931934, -0.007011705078184605, 0.0004903728840872645, -0.00023897469509392977, -0.0018813725328072906, 0.0026823317166417837, -0.012968014925718307, 0.006833124440163374, 0.007818062789738178, 0.010599765926599503, 0.015713488683104515, 0.008786591701209545, 0.00031617179047316313, 0.005233802367001772, 0.019913699477910995, 0.017275378108024597, 0.01075814850628376, 0.00886661559343338, -0.0030352368485182524, -0.015603798441588879, -0.011480661109089851, 0.007113284897059202, -0.01494968868792057, -0.006451238878071308, -0.014746762812137604, 0.005393986590206623, 0.01532166451215744, -0.01239368598908186, 0.004472335800528526, 0.013064268976449966, 0.004680140875279903, 0.006622344255447388, -0.0115412138402462, -0.004633395466953516, -0.0049819634296, -0.011251065880060196, -0.006019136868417263, 0.0028489248361438513, -0.004709904547780752, 0.012325281277298927, -0.005352458916604519, 0.020077062770724297, -0.0077957287430763245, 0.007238276768475771, -0.006716448348015547, 0.0010744716273620725, -0.004432999528944492, -0.013641702011227608, 0.009280276484787464, 0.0014411822194233537, 0.013706575147807598, 0.0016940840287134051, 0.014850806444883347, 0.014260341413319111, -0.008238257840275764, 0.020975513383746147, 0.0031471815891563892, 0.005218732636421919, -0.0089482506737113, -0.008653785102069378, -0.013093414716422558, -0.01892768405377865, -0.00029100949177518487, 0.0015590094262734056, 0.010685871355235577, -0.007810648065060377, -0.012705384753644466, -0.013084868900477886, -0.007425754331052303, -0.0018348462181165814, 0.012124809436500072, 0.004634573124349117, 0.006161960307508707, -0.019759681075811386, 0.006892597768455744, 0.013266638852655888, 0.010896647348999977, -0.00557943107560277, 0.0027194505091756582, 0.0022672261111438274, -0.002841382985934615, 0.003839692333713174, 0.014145500026643276, -0.011652004905045033, 0.0037050272803753614, -0.017536012455821037, 0.009643458761274815, -0.0026768094394356012, -0.010596278123557568, 0.0014505161670967937, -0.006636671721935272, -0.008401818573474884, 0.010938008315861225, -0.003192686941474676, -0.009458963759243488, 0.00201695435680449, 0.00015648595581296831, 0.014384469017386436, 0.003991053439676762, -0.015922071412205696, -0.00778018357232213, 0.01146305724978447, 0.009877190925180912, 0.013033495284616947, 0.009359937161207199, 0.020649103447794914, -0.004465197212994099, -0.008898787200450897, 0.049613259732723236, -0.015569424256682396, 0.011003442108631134, 0.00994484219700098, -0.0037014686968177557, 0.0115419402718544, 0.009055525064468384, 0.010901793837547302, 0.002865096088498831, 0.01270777266472578, -0.004974653013050556, -0.009307604283094406, -0.018169162794947624, 0.00795886479318142, 0.010585871525108814, 0.005480652675032616, -0.010753057897090912, -0.012467377819120884, -0.014066629111766815, 0.008126250468194485, 0.015682123601436615, 0.006795132998377085, 0.004659783095121384, -0.009080578573048115, 0.009711265563964844, 0.007848842069506645, -0.02845459058880806, 0.003332578344270587, -0.016289252787828445, -0.0036634800489991903, 0.0009082274627871811, 0.0119556225836277, -0.009252339601516724, -0.028384018689393997, -0.003981787245720625, -0.013238637708127499, -0.009469724260270596, 0.02063922956585884, -0.0005419733934104443, -0.006601364817470312, 0.013265155255794525, 0.028954826295375824, 0.005257347133010626, 0.01364483218640089, -0.013063473626971245, 0.034062087535858154, 0.0048038954846560955, 0.018448440358042717, 0.007293941918760538, -0.01530710980296135, -0.010486983694136143, -0.005843336693942547, 0.037486616522073746, -0.00033253527362830937, -0.014665238559246063, -0.0477316677570343, -0.0134495934471488, 0.01428225077688694, -0.0015635847812518477, 0.0053740148432552814, -0.006691318470984697, 0.010839988477528095, -0.020348766818642616, 0.010833070613443851, 0.0024060693103820086, 0.013937675394117832, 0.016746122390031815, -0.02130299247801304, -0.014582211151719093, 0.010318520478904247, 0.007811992894858122, -0.014929126016795635, 0.006404571235179901, -0.01764153316617012, 0.0018617913592606783, 0.021435676142573357, -0.014904368668794632, -0.009203752502799034, -0.013196620158851147, -0.0036154978442937136, 0.0028778761625289917, -0.015772085636854172, -0.013590867631137371, -0.004916369449347258, 0.04076216369867325, 0.002123205689713359, 0.0030849692411720753, 0.010077180340886116, -0.012055397033691406, 0.002181533258408308, 0.008310101926326752, -0.015912840142846107, 0.010028284974396229, -0.010056274943053722, -0.04378970339894295, 0.0012977439910173416, -0.0001493881136411801, -0.015039250254631042, -0.009932218119502068, -0.0021940399892628193, -0.030773693695664406, -0.009513386525213718, 0.007786141708493233, -0.0416141077876091, -0.00764177180826664, 0.007381429895758629, 0.016884315758943558, -0.0070206173695623875, 0.008053166791796684, 0.014031568542122841, 0.01831868477165699, -0.0026645215693861246, 0.008622861467301846, -0.022209927439689636, 0.007750168442726135, 0.008668649010360241, -0.00778179569169879, -0.005866784602403641, 0.010622605681419373, 0.007779800333082676, -0.014909864403307438, -0.0022039958275854588, -0.010589460842311382, 0.015228522941470146, -0.004766879137605429, 0.000718768045771867, 0.009322848170995712, -0.0078584598377347, 0.004403268452733755, -0.03827981278300285, -0.024549340829253197, 0.005399656947702169, 0.011449429206550121, -0.015766380354762077, -0.00287824310362339, -0.0004484331584535539, -0.010088291950523853, 0.005137413274496794, 0.013640201650559902, 0.012396967969834805, -0.01408376544713974, -0.0370585136115551, 0.003955338150262833, -0.012295734137296677, 0.0032202566508203745, 0.012528573162853718, -0.016534646973013878, -0.004742337390780449, -0.004604144487529993, 0.009046776220202446, 0.005662296433001757, -0.014577489346265793, 0.011422604322433472, 0.010088511742651463, 0.0004396663571242243, -0.014806298539042473, 0.018715422600507736, -0.00795360654592514, -0.004439061041921377, -0.00928175263106823, -0.002697346266359091, -0.008730622008442879, -0.016399390995502472, -0.011395107954740524, -0.017004068940877914, -0.008205974474549294, 0.007689390331506729, 0.04404164478182793, -0.003684036200866103, 0.01187917310744524, 0.01343029085546732, 0.01795884594321251, -0.025803448632359505, 0.0029307196382433176, 0.0178783368319273, 0.013031817972660065, -0.0047216652892529964, -0.007332017179578543, -0.004479479975998402, -0.009822581894695759, -0.012993702664971352, -0.03469116613268852, 0.0036042798310518265, -0.016879143193364143, 0.014068132266402245, -0.008665216155350208, 0.017428359016776085, 0.004752915818244219, 0.01177932508289814, 0.01702358014881611, 0.008281456306576729, 0.010221922770142555, -0.01701417937874794, 0.007783499546349049, -0.016710953786969185, -0.010930703021585941, 0.008284766227006912, 0.009267610497772694, 0.010849663987755775, -0.009906220249831676, -0.009850089438259602, 0.011682172305881977, 0.01112037431448698, 0.013306520879268646, -0.0017931523034349084, 0.007063352968543768, 0.007739116437733173, 0.011412559077143669, 0.007277907337993383, 0.00045590492663905025, 0.012522307224571705, 0.03397942706942558, -0.010017605498433113, 0.017769981175661087, 0.016685977578163147, 0.00864427350461483, 0.02759830839931965, 0.015646839514374733, -0.0105757350102067, 0.006612403318285942, 0.012645645998418331, 0.0004094093746971339, -0.04526396840810776, 0.01652715727686882, -0.01568109355866909, -0.00947263278067112, -0.013056478463113308, 0.020686602219939232, 0.002432082546874881, -0.008396869525313377, -0.014474371448159218, 0.004823832307010889, 0.013455856591463089, 0.010205601342022419, 0.003163801273331046, -0.0023690417874604464, -0.006104594562202692, -0.00984394270926714, -0.005008912645280361, -0.006767331622540951, -0.02296176552772522, 0.018230637535452843, -0.011816473677754402, -0.012353361584246159, 0.015969129279255867, 0.009223949164152145, 0.0049833799712359905, 0.018039437010884285, 0.015119833871722221, 0.013380327261984348, -0.031288716942071915, -0.021681375801563263, -0.003860374679788947, 0.0011647669598460197, 0.009683560580015182, 0.0011494886130094528, -0.020029999315738678, -0.013452442362904549, 0.0025603999383747578, -0.015301971696317196, 0.003529204521328211, 0.008581782691180706, -0.006247103679925203, 0.01852262206375599, 0.0034480986651033163, -0.007857751101255417, -0.00844576396048069, -0.011410011909902096, 0.018794607371091843, 0.0051599591970443726, 0.004987139254808426, -0.00982703547924757, 0.00775941414758563, -0.026698864996433258, 0.019011780619621277, 0.011070339940488338, 0.010693985968828201, 0.010090199299156666, -0.02315746434032917, -0.02232508175075054, 0.0021803411655128, 0.0058322264812886715, -0.008510365150868893, -0.007836624048650265, -0.005321560427546501, -0.042832523584365845, 0.0032018194906413555, -0.0021385785657912493, -0.01149282418191433, 0.015249447897076607, 0.013175452128052711, -0.013263651169836521, 0.009605638682842255, -0.0017941305413842201, -0.02001291885972023, -0.0013474788283929229, -0.008827744983136654, -0.008567972108721733, 0.009212132543325424, -0.00996236689388752, 0.013687842525541782, -0.008276982232928276, 0.010873109102249146, 0.018529420718550682, 0.015418530441820621, -0.01740819774568081, 0.011188413947820663, -0.0014055253705009818, -0.0027796393260359764, -0.011940750293433666, -0.04066712036728859, 0.01731463149189949, 0.00972654391080141, -0.006592390593141317, -0.01804983802139759, 0.0039143371395766735, 0.0037695106584578753, -0.013714639469981194, 0.007349331863224506, 0.0029637827537953854, 0.0246062520891428, 0.0051221395842731, 0.014738387428224087, -0.00761333666741848, 0.042848411947488785, -0.005427463911473751, -0.0006919362349435687, 0.011997204273939133, -0.015675220638513565, -0.00746018486097455, -0.013183214701712132, 0.005786437541246414, 0.011780004017055035, 0.0056555746123194695, -0.006640612613409758, 0.011536834761500359, 0.010778619907796383, 0.007605907507240772, -0.00793125107884407, 0.0028628932777792215, -0.0035959952510893345, 0.016353826969861984, -0.0043972390703856945, 0.003176091006025672, -0.031551435589790344, -0.016800614073872566, -0.00029083789559081197, 0.009736502543091774, -0.01568060740828514, 0.005022264551371336, -0.025480102747678757, 0.011297500692307949, 0.007581477053463459, -0.0016224546125158668, 0.005709092598408461, 0.010409335605800152, -0.016521940007805824, -0.018206123262643814, 0.006175162736326456, 0.008778166025876999, -0.0022309550549834967, -0.007818151265382767, -0.03120935522019863, -0.005533173680305481, 0.009598633274435997, 0.0052389586344361305, -0.011546196416020393, -0.015386946499347687, -0.01108638383448124, -0.008367440663278103, -0.00966842845082283, 0.0038232433144003153, 0.002250339137390256, -0.007798489648848772, -0.012713105417788029, -0.012308475561439991, 0.000805867719464004, -0.03699140623211861, -0.002285389695316553, 0.007590573746711016, 0.019650356844067574, 0.010974128730595112, 0.020700780674815178, -0.004973871633410454, -0.018670298159122467, -0.005803109612315893, -0.006809563841670752, 0.016614830121397972, -0.0033224429935216904, 0.006634657271206379, -0.019182706251740456, 0.021176280453801155, 0.015435757115483284, -0.014950122684240341, 0.008246991783380508, 0.006445802748203278, 0.012333661317825317, -0.008204870857298374, 0.0019543180242180824, 0.014200412668287754, -0.003515804186463356, -0.016742540523409843, -0.01891338638961315, -0.0027654762379825115, 0.03170795366168022, -0.010842233896255493, -0.010463311336934566, -0.012307148426771164, -0.006837755441665649, -0.006377180572599173, 0.0003726479772012681, 0.0074117667973041534, 0.012237879447638988, 0.013926982879638672, 0.020631570369005203, 0.015281918458640575, -0.01423019077628851, -0.0005792565061710775, -0.016466457396745682, -0.015991928055882454, 0.02210184372961521, 0.0029620579443871975, 0.014470742084085941, 0.006499689072370529, 0.0052145919762551785, -0.0022779505234211683, -0.0005910294712521136, 0.007743953261524439, -0.013304995372891426, -0.014860337600111961, 0.0016594571061432362, 0.021982410922646523, 0.0053792656399309635, -0.006159000098705292, -0.011754034087061882, -0.009131165221333504, -0.026140481233596802, -0.006821175571531057, -0.0017507964512333274, -0.011281176470220089, -0.0054891170002520084, 0.00690798694267869, -0.012782307341694832, 0.006865228526294231, -0.012725220061838627, -0.0005758189363405108, -0.0032314336858689785, -0.007406175136566162, -0.005889317020773888, 0.00980266835540533, -0.011635364964604378, 3.5246001061750576e-05, 0.004407546482980251, -0.009955312125384808, 0.009285123087465763, -0.005646799225360155, 0.00839957408607006, 0.018026096746325493, 0.004464535042643547, -0.0033787370193749666, 0.0056716809049248695, 0.007172589655965567, 0.04039851203560829, -0.013527682982385159, -0.007139946799725294, -0.012617859058082104, 0.0043635922484099865, 0.006751716136932373, 0.020184364169836044, 0.0010630638571456075, 0.0026791058480739594, 1.7988177205552347e-05, 0.008669907227158546, 0.0038231259677559137, -0.018102549016475677, -0.02744770422577858, -0.012456501834094524, -0.014035225845873356, 0.023726044222712517, 0.010654986836016178, 0.003248996566981077, -0.00682978518307209, -0.0037176781333982944, 0.015079095028340816, 0.01221485435962677, -0.009922557510435581, -0.01690678671002388, -0.019313545897603035, 0.011571202427148819, -0.0028497176244854927, 0.006475233472883701, 0.016590023413300514, -0.010714645497500896, 0.0046804859302937984, 0.02245885133743286, -0.015548096038401127, 0.0028136279433965683, 0.000475766253657639, 0.008623139932751656, -0.01225144974887371, 0.0064099798910319805, 0.007680435664951801, 0.014606193639338017, -0.010183272883296013, -0.008839295245707035, 0.004103530663996935, -0.0017371665453538299, 0.04099612683057785, 0.0032622148282825947, -0.02103296108543873, -0.01213521882891655, 0.001018795883283019, 0.008710996247828007, 0.047211453318595886, 0.008835515938699245, 0.013697249814867973, -0.016189897432923317]]
    let cls_bias = [0.021088650450110435, -0.0021209302358329296]

    const cls = cls_bias.map((b,i) => {
        let res = 0
        out.data.forEach((o, j) => {
            res += o * cls_weigths[i][j]
        })
        return res + b
    })

    function softmax(arr) {
        return arr.map(function(value,index) { 
            let res =Math.exp(value) / arr.map( function(y /*value*/){ return Math.exp(y) } ).reduce( function(a,b){ return a+b })
          return res.toFixed(2)
        })
    }
    let prob_pred = softmax(cls)

    console.log(text, tokens, out)
    self.postMessage({
        status: 'complete',
        type: type,
        tokens: tokens,
        encodings: encodings,
        first_probs: first_probs,
        last_probs: last_probs,
        prob_pred: prob_pred
    });
}
});
